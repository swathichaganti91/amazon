pipeline:
  agent: any

  environment:
    SONARQUBE: 'sonar'   # Your SonarQube server config name in Jenkins

  stages:
    - stage: Checkout
      steps:
        - echo: "Checking out source code..."
        - git:
            branch: 'main'
            url: 'https://github.com/CloudTechDevOps/project-1-maven-jenkins-CICD-docker-eks-.git'

    - stage: Build
      steps:
        - echo: "Building the project with Maven..."
        - sh: 'mvn clean package'

    - stage: SonarQube Analysis
      steps:
        - echo: "Running SonarQube analysis..."
        - withSonarQubeEnv: "${SONARQUBE}"
        - withCredentials:
            - string:
                credentialsId: 'SONAR_TOKEN'  # Jenkins credential ID for your Sonar token
                variable: 'SONAR_TOKEN'
          steps:
            - sh: |
                mvn sonar:sonar \
                  -Dsonar.projectKey=com.example.maven-project:maven-project \
                  -Dsonar.host.url=http://13.235.55.125:9000 \
                  -Dsonar.login=d96c89b9273815f623791ea65af414ab288a96cc



    - stage: Quality Gate
      steps:
        - echo: "Waiting for SonarQube Quality Gate..."
        - script: |
            def qg = waitForQualityGate()
            echo "Quality Gate status: ${qg.status}"
            if (qg.status != 'OK') {
              error("Pipeline failed due to Quality Gate failure: ${qg.status}")
            } else {
              echo "Quality Gate Passed!"
            }

  post:
    always:
      - echo: "Post actions always run"
    success:
      - echo: "Pipeline succeeded!"
    failure:
      - echo: "Pipeline failed!"
